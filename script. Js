"use strict";
const lang = "en";

window.onload = function () {
    cardsContainer = document.getElementById("contentBox");
    searchBox = document.getElementById("searchbox");
    btnConfirm = document.getElementById("confirm");
    windowWidth = window.innerWidth;
    addEvents();
};

//#region Global Variables
//DOM elements
var searchBox, btnConfirm, cardsContainer;
//Data holders
var cards = {};
var windowWidth;
//Helpers
const initRnd = 25; // Number of random cards displayed when loading
var timed = 0; // Used for setTimeOut loading few cards at time
var dispCtn = 0; // Used to count the cards that were already loaded
//#endregion

function addEvents() {
    btnConfirm.onclick = searchAndDisplay;
    searchBox.oninput = searchAndDisplay;
    window.onresize = updateWindowWidth;
}

function updateWindowWidth() {
    windowWidth = window.innerWidth;
}

function searchAndDisplay() {
    clearTimeout(timed);
    dispCtn = 0;
    clearCardsContainer();
    var txt = searchBox.value.toLowerCase();
    var filtered = [];
    for (const [k, v] of Object.entries(cards)) {
        if (String(v.name).toLowerCase().includes(txt)) filtered.push(k);
    }
    displayTimed(filtered);
}

function displayTimed(keys) {
    let i = 0;
    while (i < windowWidth / 85 && dispCtn < keys.length) {
        let name = "./final_assets/final_" + keys[dispCtn] + ".png";
        addCard(name, cards[keys[dispCtn]]);
        dispCtn++;
        i++;
    }
    if (dispCtn < keys.length) {
        timed = setTimeout(displayTimed, 100, keys);
    }
}

function displayRandom(n) {
    var keys = Object.keys(cards);
    var rndKeys = {};
    while (n > 0) {
        let rnd = Math.floor(Math.random() * keys.length);
        if (!rndKeys[rnd]) {
            rndKeys[rnd] = 1;
            n--;
            let filePicName = "./final_assets/final_" + keys[rnd] + ".png";
            addCard(filePicName, cards[keys[rnd]]);
        }
    }
    let fi = "./final_assets/final_" + keys[1] + ".png";
    cardsContainer.appendChild(createDetailedCard(fi, cards[keys[1]]));
}

function clearCardsContainer() {
    while (contentBox.firstChild) {
        contentBox.removeChild(contentBox.firstChild);
    }
}

function addCard(fileName, card) {
    const newDiv = document.createElement("div");
    newDiv.className = "card";
    newDiv.id = card.id;
    const cardName = document.createElement("p");
    cardName.className = "cardName";
    cardName.innerHTML = String(card.name);

    const cardPic = document.createElement("img");
    cardPic.className = "cardPic";

    newDiv.append(cardName);
    newDiv.append(cardPic);
    newDiv.onclick = clickCard;

    cardsContainer.appendChild(newDiv);
    return newDiv;
}

function clickCard(e) {
    e.currentTarget.className = e.currentTarget.className == "cardSelected" ? "card" : "cardSelected";
}

function loadCardsData() {
    const filter = (c) => {
        return (
            c.open_at != "2030-12-31 23:59:59" &&
            c.id[0] != "9" &&
            String(c.id).endsWith("0") &&
            c.leader_skill_set_id != ""
        );
    };
    const arrCards = [];
    cards = [];
    // Object.assign(cards, ...arrCards.map((f) => ({ [f.id]: f })));
    displayRandom(initRnd);
}
